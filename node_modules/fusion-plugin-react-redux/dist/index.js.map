{"version":3,"file":"index.js","sources":["../src/ctx-enhancer.js","../src/tokens.js","../src/browser.js","../src/server.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport {createStore} from 'redux';\nimport type {Store} from 'redux';\n\nimport type {Context} from 'fusion-core';\n\ntype CreateStoreType = typeof createStore;\ntype StoreWithContextType = Store<*, *, *> & {ctx: Context};\n\nexport default (ctx?: Context) => (createStore: CreateStoreType) => (\n  ...args: any\n) => {\n  const store: StoreWithContextType = {\n    ...createStore(...args),\n    ctx: ctx,\n  };\n  return store;\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Reducer, StoreEnhancer} from 'redux';\n\nimport {createToken} from 'fusion-core';\nimport type {Token, Context} from 'fusion-core';\n\nimport type {ReactReduxServiceType} from './types.js';\n\ntype InitialStateType<TState> = (ctx: Context) => Promise<TState> | TState;\n\nexport const ReduxToken: Token<ReactReduxServiceType> = createToken(\n  'ReduxToken'\n);\nexport const ReducerToken: Token<Reducer<*, *>> = createToken('ReducerToken');\nexport const PreloadedStateToken: Token<Object> = createToken(\n  'PreloadedStateToken'\n);\nexport const EnhancerToken: Token<StoreEnhancer<*, *, *>> = createToken(\n  'EnhancerToken'\n);\nexport const GetInitialStateToken: Token<\n  InitialStateType<Object>\n> = createToken('GetInitialStateToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n/* globals __REDUX_DEVTOOLS_EXTENSION__ */\n\nimport React from 'react';\nimport {Provider} from 'react-redux';\nimport {compose, createStore} from 'redux';\n\nimport {createPlugin, unescape} from 'fusion-core';\nimport type {Context, FusionPlugin} from 'fusion-core';\n\nimport ctxEnhancer from './ctx-enhancer';\nimport {ReducerToken, PreloadedStateToken, EnhancerToken} from './tokens.js';\nimport type {\n  StoreWithContextType,\n  ReactReduxDepsType,\n  ReactReduxServiceType,\n} from './types.js';\n\nconst getPlugin = () => {\n  let storeCache = null;\n  return createPlugin({\n    deps: {\n      reducer: ReducerToken,\n      preloadedState: PreloadedStateToken.optional,\n      enhancer: EnhancerToken.optional,\n    },\n    provides({reducer, preloadedState, enhancer}) {\n      class Redux {\n        store: StoreWithContextType<*, *, *>;\n\n        constructor(ctx) {\n          if (storeCache) {\n            // $FlowFixMe\n            this.store = storeCache;\n          } else {\n            // We only use initialState for client-side hydration\n            // The real initial state should be derived from the reducer and the @@INIT action\n            if (!preloadedState) {\n              const stateElement = document.getElementById('__REDUX_STATE__');\n              if (stateElement) {\n                preloadedState = JSON.parse(unescape(stateElement.textContent));\n              }\n            }\n            const devTool =\n              __DEV__ &&\n              window.__REDUX_DEVTOOLS_EXTENSION__ &&\n              // $FlowFixMe\n              __REDUX_DEVTOOLS_EXTENSION__();\n            const enhancers = [enhancer, ctxEnhancer(ctx), devTool].filter(\n              Boolean\n            );\n            // $FlowFixMe\n            this.store = createStore(\n              reducer,\n              preloadedState,\n              // $FlowFixMe\n              compose(...enhancers)\n            );\n            storeCache = this.store;\n          }\n        }\n      }\n      return {\n        from: (ctx?: Context) => {\n          return new Redux(ctx);\n        },\n      };\n    },\n    middleware(_, redux) {\n      return (ctx, next) => {\n        const {store} = redux.from(ctx);\n        ctx.element = <Provider store={store}>{ctx.element}</Provider>;\n        return next();\n      };\n    },\n  });\n};\n\nexport default ((getPlugin: any): () => FusionPlugin<\n  ReactReduxDepsType,\n  ReactReduxServiceType\n>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React from 'react';\nimport {compose, createStore} from 'redux';\nimport {Provider} from 'react-redux';\n\nimport {createPlugin, memoize, html} from 'fusion-core';\nimport type {FusionPlugin, Context} from 'fusion-core';\n\nimport ctxEnhancer from './ctx-enhancer';\nimport {\n  ReducerToken,\n  PreloadedStateToken,\n  EnhancerToken,\n  GetInitialStateToken,\n} from './tokens.js';\nimport type {\n  StoreWithContextType,\n  ReactReduxDepsType,\n  ReactReduxServiceType,\n} from './types.js';\n\nconst plugin =\n  __NODE__ &&\n  createPlugin({\n    deps: {\n      reducer: ReducerToken,\n      preloadedState: PreloadedStateToken.optional,\n      enhancer: EnhancerToken.optional,\n      getInitialState: GetInitialStateToken.optional,\n    },\n    provides({reducer, preloadedState, enhancer, getInitialState}) {\n      class Redux {\n        ctx: Context;\n        store: ?StoreWithContextType<*, *, *>;\n\n        constructor(ctx) {\n          // We only use initialState for client-side hydration\n          // The real initial state should be derived from the reducer and the @@INIT action\n          this.ctx = ctx;\n          this.store = null;\n        }\n        async initStore() {\n          if (this.store) {\n            return this.store;\n          }\n          if (getInitialState) {\n            preloadedState = Object.assign(\n              {},\n              preloadedState,\n              await getInitialState(this.ctx)\n            );\n          }\n          const enhancers = [enhancer, ctxEnhancer(this.ctx)].filter(Boolean);\n          // $FlowFixMe\n          this.store = createStore(\n            reducer,\n            preloadedState,\n            // $FlowFixMe\n            compose(...enhancers)\n          );\n          return this.store;\n        }\n      }\n      return {\n        from: memoize(ctx => new Redux(ctx)),\n      };\n    },\n    middleware(_, redux) {\n      return async (ctx, next) => {\n        if (!ctx.element) return next();\n        const store = await redux.from(ctx).initStore();\n        ctx.element = <Provider store={store}>{ctx.element}</Provider>;\n        await next();\n\n        const serialized = JSON.stringify(store.getState());\n        const script = html`<script type=\"application/json\" id=\"__REDUX_STATE__\">${serialized}</script>`;\n        ctx.template.body.push(script);\n      };\n    },\n  });\n\nexport default ((plugin: any): FusionPlugin<\n  ReactReduxDepsType,\n  ReactReduxServiceType\n>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport browserPlugin from './browser';\nimport serverPlugin from './server';\n\nexport default (__NODE__ ? serverPlugin : browserPlugin());\n\nexport {\n  ReduxToken,\n  ReducerToken,\n  PreloadedStateToken,\n  EnhancerToken,\n  GetInitialStateToken,\n} from './tokens';\n"],"names":["ctx","createStore","args","store","ReduxToken","createToken","ReducerToken","PreloadedStateToken","EnhancerToken","GetInitialStateToken","plugin","createPlugin","deps","reducer","preloadedState","optional","enhancer","getInitialState","provides","Redux","constructor","initStore","Object","assign","enhancers","ctxEnhancer","filter","Boolean","compose","from","memoize","middleware","_","redux","next","element","Provider","serialized","JSON","stringify","getState","script","html","template","body","push","serverPlugin"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAUA,AAQA,mBAAgBA,GAAD,IAAoBC,WAAD,IAAkC,CAClE,GAAGC,IAD+D,KAE/D;QACGC,KAA2B,qBAC5BF,WAAW,CAAC,GAAGC,IAAJ,CADiB;IAE/BF,GAAG,EAAEA;IAFP;;SAIOG,KAAP;CAPF;;AClBA;;;;;;;AAUA,AAOO,MAAMC,UAAwC,GAAGC,sBAAW,CACjE,YADiE,CAA5D;AAGP,AAAO,MAAMC,YAAkC,GAAGD,sBAAW,CAAC,cAAD,CAAtD;AACP,AAAO,MAAME,mBAAkC,GAAGF,sBAAW,CAC3D,qBAD2D,CAAtD;AAGP,AAAO,MAAMG,aAA4C,GAAGH,sBAAW,CACrE,eADqE,CAAhE;AAGP,AAAO,MAAMI,oBAEZ,GAAGJ,sBAAW,CAAC,sBAAD,CAFR;;AC3BP;;;;;;;;;;;;ACAA;;;;;;;AAQA,AAoBA,MAAMK,MAAM,GACV,QACAC,uBAAY,CAAC;EACXC,IAAI,EAAE;IACJC,OAAO,EAAEP,YADL;IAEJQ,cAAc,EAAEP,mBAAmB,CAACQ,QAFhC;IAGJC,QAAQ,EAAER,aAAa,CAACO,QAHpB;IAIJE,eAAe,EAAER,oBAAoB,CAACM;GAL7B;;EAOXG,QAAQ,CAAC;IAACL,OAAD;IAAUC,cAAV;IAA0BE,QAA1B;IAAoCC;GAArC,EAAuD;UACvDE,KAAN,CAAY;MAIVC,WAAW,CAACpB,GAAD,EAAM;;;aAGVA,GAAL,GAAWA,GAAX;aACKG,KAAL,GAAa,IAAb;;;YAEIkB,SAAN,GAAkB;YACZ,KAAKlB,KAAT,EAAgB;iBACP,KAAKA,KAAZ;;;YAEEc,eAAJ,EAAqB;UACnBH,cAAc,GAAGQ,MAAM,CAACC,MAAP,CACf,EADe,EAEfT,cAFe,GAGf,MAAMG,eAAe,CAAC,KAAKjB,GAAN,CAHN,EAAjB;;;cAMIwB,SAAS,GAAG,CAACR,QAAD,EAAWS,WAAW,CAAC,KAAKzB,GAAN,CAAtB,EAAkC0B,MAAlC,CAAyCC,OAAzC,CAAlB,CAXgB;;aAaXxB,KAAL,GAAaF,iBAAW,CACtBY,OADsB,EAEtBC,cAFsB;QAItBc,aAAO,CAAC,GAAGJ,SAAJ,CAJe,CAAxB;eAMO,KAAKrB,KAAZ;;;;;WAGG;MACL0B,IAAI,EAAEC,kBAAO,CAAC9B,GAAG,IAAI,IAAImB,KAAJ,CAAUnB,GAAV,CAAR;KADf;GAxCS;;EA4CX+B,UAAU,CAACC,CAAD,EAAIC,QAAJ,EAAW;WACZ,OAAOjC,GAAP,EAAYkC,IAAZ,KAAqB;UACtB,CAAClC,GAAG,CAACmC,OAAT,EAAkB,OAAOD,IAAI,EAAX;YACZ/B,KAAK,GAAG,MAAM8B,QAAK,CAACJ,IAAN,CAAW7B,GAAX,EAAgBqB,SAAhB,EAApB;MACArB,GAAG,CAACmC,OAAJ,GAAc,oBAACC,mBAAD;QAAU,KAAK,EAAEjC;SAAQH,GAAG,CAACmC,OAA7B,CAAd;YACMD,IAAI,EAAV;YAEMG,UAAU,GAAGC,IAAI,CAACC,SAAL,CAAepC,KAAK,CAACqC,QAAN,EAAf,CAAnB;YACMC,MAAM,GAAGC,eAAK,wDAAuDL,UAAW,WAAtF;MACArC,GAAG,CAAC2C,QAAJ,CAAaC,IAAb,CAAkBC,IAAlB,CAAuBJ,MAAvB;KARF;;;CA7CQ,CAFd;;AC5BA;;;;;;;AAQA,AAGA,YAA2BK,MAA3B;;;;;;;;;"}